name: Refresh Brewing Statistics

on:
  workflow_dispatch:  # Manual trigger only
  #push:
  #  branches:
  #    - master  # Auto-trigger on push to master
  schedule:
    - cron: '0 0 * * 0'

jobs:
  refresh-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit to master branch

    steps:
      - name: ðŸº Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ðŸ“¦ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: ðŸ“¥ Fetch and analyze brewing data
        env:
          BREWFATHER_USER_ID: ${{ secrets.BREWFATHER_USER_ID }}
          BREWFATHER_API_KEY: ${{ secrets.BREWFATHER_API_KEY }}
        run: |
          chmod +x refresh_stats.sh
          ./refresh_stats.sh

      - name: ðŸ“ Commit updated statistics
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add brewing_statistics.json
          git commit -m "ðŸ“Š Update brewing statistics - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push

      - name: ðŸŽ‰ Summary
        run: |
          echo "## ðŸº Brewing Statistics Refresh Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Data fetched from Brewfather API" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Statistics analyzed and generated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… brewing_statistics.json committed to master branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ View your showcase at: https://sklopivo.github.io/" >> $GITHUB_STEP_SUMMARY
